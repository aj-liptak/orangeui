<script type="text/javascript" src="../lib/jquery-1.7.2.min.js"></script>
<script src="../sandbox/src/commons.js" type="text/javascript"></script>
<script src="../sandbox/src/mvc.js" type="text/javascript"></script>
<script src="../sandbox/src/ui.js" type="text/javascript"></script>
<script src="../sandbox/plugins/cakephp/cakephp.js" type="text/javascript"></script>
<script src="../lib/inflection.js" type="text/javascript"></script>
<script src="controllers.js" type="text/javascript"></script>

<!-- iOS meta rules -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">

<!-- viewport rules -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

<link type="text/css" rel="stylesheet" href="styles.css" />

<script type="text/javascript">

Orange.use('mvc', 'ui', function(O) {

	var app = new O.Application('contacts', {
		version: '1.0',
		logging: 'info',
		location: true,
		required: ['mvc', 'ui', 'cakephp']
	});

	O.namespace('Contacts');

	var ContactsSource = new O.CakePHP.CakeSource({
		name: 'contacts_source',
		path: '/contacts'
	});

	O.Contacts.Contact = O.Model.extend({
	
		getName: function() {
			return 'contact';
		},
		
		getFields: function() {
			return {
				contactId: { name: 'id', type: 'key', nullable: false, primaryKey: true },
				firstName: { name: 'first_name', type: 'text', nullable: false },
				lastName: { name: 'last_name', type: 'text', nullable: false },
				email: { name: 'email', type: 'email', nullable: true },
				phone: { name: 'phone', type: 'tel', nullable: true },
				birthday: { name: 'birthday', type: 'date', nullable: true },
			}
		},
		
		getSource: function() {
			return ContactsSource;
		}
	
	});
	
	var Contact = O.Contacts.Contact;

	O.Contacts.ContactApp = O.ViewController.extend({
	
		getType: function() {
			return 'contact-app';
		},
		
		getBindings: function() {
			return {
				'add-btn': { touchclick: this.onAdd }
			}
		},
		
		onAdd: function() {
			
			this.setView('edit', new O.Contacts.EditView(this, O.View.load('views/edit-view.html')));
			this.getView('edit').load();
			this.target.append(this.getView('edit').target);
			this.getView('edit').show();
			this.getView('edit').on('close', this.onClose, this);
		},
		
		onClose: function() {
			this.getView('edit').hide();
			this.getView('edit').unload();
			this.clearView('edit');
		}
	
	});

	O.Contacts.ContactView = O.ViewController.extend({
	
		getType: function() {
			return 'contact-view';
		},
		
		onDidLoad: function() {
		
			var binding = new O.Binding(this.find('ul'));
		
			O.Contacts.Contact.getAll({}, Class.proxy(function(data) {
				console.log(data);
				binding.bindList(data);
			}, this), function() {});
			
			this._super();
		
		},
		
		onClick: function() {
		
		}
	
	});
	
	O.Contacts.EditView = O.ViewController.extend({
	
		getType: function() {
			return 'edit-view';
		},
		
		onDidLoad: function() {
			
			this._super();
		
		},
		
		onWillAppear: function() {
			this.find('.save-btn').on('click', Class.proxy(this.onSave, this));
			this.target.on('click', Class.proxy(function() {
				this.fire('close');
			}, this));
			this.target.find('.edit-form').on('click', function(e) {
				e.stopPropagation();
			});
		},
		
		onWillDisppear: function() {
			this.target.off('click');
		},
		
		onSave: function() {
			this.fire('close');
			var data = this.getForm('edit').getData();
			Contact.set(data, function(data) { this.fire('close'); }, function() { console.log('error'); }, this);
		}
	
	});

});

</script>

<style type="text/css">

body {
	background-color: #F8F8F8;
}

.contacts-app {
	width: 100%;
}

a {
	color: #333;
	text-decoration: none;
}

h1 {
	color: #FFF;
	float: left;
	font-size: 24px;
	font-weight: 500;
	line-height: 80px;
	margin: 0;
	padding: 0 20px;
}

.toolbar {
	background-color: #585E66;
	height: 80px;
}

.add-btn {
	background: url(img/add-icon.png);
	cursor: pointer;
	float: right;
	height: 40px;
	margin: 20px;
	width: 40px;
}

.contact-view ul {
	list-style: none;
	margin: 0;
	padding: 0;
}

.contact-view ul > li {
	background: #FFF;
	color: #333;
	font-size: 14px;
	margin: 10px;
	padding: 15px;
	-webkit-box-shadow: 0px 0px 5px rgba(0, 0, 0, .25);
}

.contact-view ul > li span {
	display: block;
}

.contact-view ul > li .name {
	color: #92A7BD;
	font-size: 20px;
	font-weight: bold;
	padding-bottom: 10px;
}

.contact-view ul > li .name span {
	display: inline-block;
}

@media only screen and (-webkit-min-device-pixel-ratio:1.5), only screen and (min-device-pixel-ratio:1.5) {

	.add-btn {
		background-image: url(img/add-icon@2x.png);
		background-size: 40px 40px;
		-webkit-background-size: 40px 40px;
	}

}

.edit {
	background: rgba(0, 0, 0, .7);
	height: 100%;
	position: fixed;
	top: 0;
	width: 100%;
	z-index: 100;
}

.edit-form {
	background: #FFF;
	position: absolute;
	overflow-x: hidden;
	overflow-y: scroll;
	height: 80%;
	margin: 10%;
	width: 80%;	
}

.edit-form form {
	padding: 15px 20px;
}

.edit-form h2 {
	padding: 0;
	margin: 0;
	padding-left: 20px;
	padding-top: 15px;
}

.edit-form input[type="text"], .edit-form input[type="url"], .edit-form input[type="email"], 
.edit-form input[type="date"], .edit-form input[type="tel"] {
	display: block;
	font-size: 13px;
	padding: 10px;
	margin-bottom: 15px;
	margin-right: 15px;
	width: 100%;
	border-radius: 5px;
	box-shadow: none;
	outline: none;
	border: 1px solid #DDD;
	-webkit-transition: box-shadow 100ms ease-in-out 0s;
}

.edit-form input[type="text"]:focus, .edit-form input[type="url"]:focus, .edit-form input[type="email"]:focus, 
.edit-form input[type="date"]:focus, .edit-form input[type="tel"]:focus {
	box-shadow: 0 0 0px 3px #369CE1;
	-webkit-transition: box-shadow 100ms ease-in-out 0s;
}

@media screen and (min-width: 500px) {

	.edit-form input[name="firstName"] {
		display: inline-block;
		float: left;
		margin-right: 0;
		width: 48%;
	}
	
	.edit-form input[name="lastName"] {
		display: inline-block;
		float: right;
		margin-right: 0;
		width: 48%;
	}

}

</style>

<body>

<div data-control="contact-app" data-name="contacts-app" data-root>

	<div class="toolbar">
	
		<h1>Contacts Demo</h1>
		
		<div data-name="add-btn"></div>
	
	</div>
	
	<div data-control="contact-view" data-name="contact-view">
	
		<ul>
			
			<li itemscope>
				<div class="name">
					<span itemprop="firstName">Kevin</span>
					<span itemprop="lastName">Kinnebrew</span>
				</div>
				<span itemprop="email">kevin.kinnebrew@gmail.com</span>
				<span itemprop="phone">773.972.2363</span>
				<span itemprop="website"><a href="http://www.kevinkinnebrew.com">http://www.kevinkinnebrew.com</a></span>
				<span itemprop="birthday">Aug 8</span>
			</li>
			
		</ul>
	
	</div>

</div>

</body>