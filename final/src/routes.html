<script type="text/javascript">

var AppController = ViewController.extend({

	getType: function() {
		return 'social-app';
	},

	getParams: function() {
		return;
	}

});

var LoginController = ViewController.extend({
	
	getType: function() {
		return 'social-login';
	},
	
	getParams: function() {
		return;
	}

});

var SetupController = ViewController.extend({
	
	getType: function() {
		return 'social-setup';
	},
	
	getParams: function() {
		return;
	}

});

var MainController = UINavigationController.extend({
	
	// configuration
	
	getType: function() {
		return 'social-main';
	},
	
	getParams: function() {
		return;
	},
	
	getBindings: function() {
		return {
			'feed': { 'logout': this.onLogout },
			'event': { 'back': this.onBack }
		}
	},
	
	getRoutes: function() {
		return {
			'/': 'routeFeed',
			'/feed': 'routeFeed',
			'/event': 'routeEvent'
			}
		}
	},
	
	// state handlers
	
	routeFeed: function() {
		this.popToRootView();
	},
	
	routeEvent: function() {
		this.pushView('event');
	},
	
	// event handlers
	
	onLogout: function() {
		
		// bind logout events
		User.on('logout', this.onLogoutSuccess, this.onLogoutError, this);
		
		// logout user
		User.logout();
		
	},
	
	onBack: function() {
		this.setState('feed');
	},

	// request handlers
	
	onLogoutSuccess: function(e) {
		this.fire('logout');
	},
	
	onLogoutError: function(e) {
		Log.warn('Could not logout');
	}

});

var FeedListController = ViewController.extend({

	// configuration

	getType: function() {
		return 'social-feed';
	},
	
	getParams: function() {
		return ['id'];
	},
	
	getBindings: function() {
		'createBtn': { 'touchclick': this.onCreate }
	},
	
	getRoutes: function() {	
		return {
			'/': 'routeDefault',
			'/create': 'routeCreate'
		}	
	},
	
	// view managers
	
	onDidLoad: function() {
	
		// add modal create view
		this.setView('create', CreateController, 'create.html');
		
		// call super
		this._super();
	
	},
	
	onWillUnload: function() {
	
		// clear view
		this.clearView('create');
	
		// call super
		this._super();
		
	},
	
	// state handlers
	
	routeDefault: function() {
		this.getView('create').hide().unload();	
	},
	
	routeCreate: function() {
		this.getView('create').load().show();
	},
	
	// event handlers
	
	onCreate: function() {
		this.setState('create');
	}
	
});

var EventController = ViewController.extend({
	
	// configuration
	
	getType: function() {
		return 'social-event';
	},
	
	getParams: function() {
		return ['id'];
	},
	
	getBindings: function() {
		return {
			'attendBtn': { 'touchclick': 'onAttend' }
		}
	},
	
	// view managers
	
	onDidLoad: function() {
	
		// bind data if already set
		if (this.event) this.bindData(this.event, true);
		
		// call parent
		this._super();
	
	},
	
	onWillUnload: function() {
	
		// unbind data if binding exists
		this.unbindData();
		
		// delete model reference
		if (this.event) {
			this.event.destroy();
			delete this.event;
		}
	
		// call parent
		this._super();
	
	}
	
	// event handlers
	
	onAttend: function() {
		
		// if no event set, return
		if (!this.event) {
			Log.warn('Event not set');
			return;
		}
		
		// get value
		var btn = this.getElement('attendBtn');
		
		// check for state
		if (btn.val() == "Unattend Event") {
			this.event.clearAttending();
			btn.val("Attend Event");
		} else {
			this.event.markAttending();
			btn.val("Unattend Event");
		}
		
	},
	
	// data bindings
	
	setEvent: function(item) {
	
		// create variable
		this.event = null;
		
		// check item
		if (item instanceof Model) {
			this.event = item;
		}
		
		// bind data if loaded
		if (this.loaded) {
			this.bindData(this.event, true);
		}
	}

});

var CreateController = ViewController.extend({
	
	getType: function() {
		return 'social-create';
	},
	
	getParams: function() {
		return;
	}

});

</script>

<body>

<div data-control="social-app" data-name="app" data-root="true"> <!-- / -->

	<div data-control="social-login" data-name="login"></div> <!-- /login -->
	
	<div data-control="social-setup" data-name="setup"></div> <!-- /setup -->
	
	<div data-control="social-main" data-name="feed"> <!-- /feed -->
	
		<div data-control="social-feed" data-name="feed"></div> <!-- /feed:id -->
		
		<div data-control="social-event" data-name="event"></div> <!-- /feed:id/event:id -->
	
	</div>

</div>

</body>